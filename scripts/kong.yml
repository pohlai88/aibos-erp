# Kong Gateway Configuration for AI-BOS ERP
# This configuration sets up API gateway with authentication and rate limiting

_format_version: '3.0'

services:
  - name: aibos-bff
    url: http://host.docker.internal:3001
    routes:
      - name: bff-api
        paths:
          - /api
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 100
          hour: 1000
          policy: redis
          redis_host: redis
          redis_port: 6379
          redis_password: aibos_redis_password
      - name: cors
        config:
          origins:
            - 'http://localhost:3000'
            - 'http://localhost:3001'
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - PATCH
            - OPTIONS
          headers:
            - Accept
            - Accept-Version
            - Content-Length
            - Content-MD5
            - Content-Type
            - Date
            - X-Auth-Token
            - Authorization
          exposed_headers:
            - X-Auth-Token
          credentials: true
          max_age: 3600
      - name: request-transformer
        config:
          add:
            headers:
              - "X-Forwarded-For:$(headers['x-forwarded-for'])"
              - "X-Real-IP:$(headers['x-real-ip'])"
      - name: response-transformer
        config:
          add:
            headers:
              - "X-Response-Time:$(headers['x-response-time'])"
              - "X-Request-ID:$(headers['x-request-id'])"

  - name: aibos-web
    url: http://host.docker.internal:3000
    routes:
      - name: web-app
        paths:
          - /
        methods:
          - GET
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 200
          hour: 2000
          policy: redis
          redis_host: redis
          redis_port: 6379
          redis_password: aibos_redis_password

consumers:
  - username: aibos-admin
    custom_id: admin-user
    keyauth_credentials:
      - key: aibos-admin-key-12345
  - username: aibos-service
    custom_id: service-user
    keyauth_credentials:
      - key: aibos-service-key-67890

plugins:
  - name: prometheus
    config:
      per_consumer: true
      status_code_metrics: true
      latency_metrics: true
      bandwidth_metrics: true
      upstream_health_metrics: true
