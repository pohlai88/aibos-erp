# AIBOS UI Ecosystem Refactoring Plan

**Step-by-step plan to refactor the UI ecosystem for clean builds and proper layer separation**

## 🎯 Objectives

1. **Clean Layer Separation**: UI Primitives → UI-Business → Apps
2. **Zero Circular Dependencies**: Proper dependency flow
3. **Clean Builds**: All packages build independently
4. **Type Safety**: Full TypeScript coverage
5. **Performance**: Optimized bundle sizes

## 📊 Current State Analysis

### Current Violations Found

1. **Layer Boundary Violations**
   - Apps importing directly from `@aibos/ui` instead of `@aibos/ui-business`
   - Business logic mixed in UI primitives
   - Generic components in business layer

2. **Dependency Issues**
   - Potential circular dependencies
   - Missing dependency declarations
   - Inconsistent import patterns

3. **Build Issues**
   - Build order dependencies
   - Type generation conflicts
   - Bundle size concerns

## 🔄 Refactoring Phases

### Phase 1: Audit & Preparation (Week 1)

#### 1.1 Dependency Audit

```bash
# Create audit script
cat > scripts/audit-dependencies.js << 'EOF'
const fs = require('fs');
const path = require('path');

function auditDependencies() {
  const violations = [];
  
  // Check apps importing from ui directly
  const appsDir = 'apps';
  const uiBusinessDir = 'packages/ui-business';
  
  // Scan for violations
  console.log('🔍 Scanning for dependency violations...');
  
  return violations;
}

auditDependencies();
EOF

# Run audit
node scripts/audit-dependencies.js
```

#### 1.2 Component Inventory

```bash
# Create component inventory
cat > scripts/inventory-components.js << 'EOF'
const fs = require('fs');
const path = require('path');

function inventoryComponents() {
  const inventory = {
    ui: [],
    uiBusiness: [],
    apps: []
  };
  
  // Scan packages/ui for components
  // Scan packages/ui-business for components  
  // Scan apps for components
  
  console.log('📋 Component Inventory:');
  console.log(JSON.stringify(inventory, null, 2));
}

inventoryComponents();
EOF

node scripts/inventory-components.js
```

#### 1.3 Build Test

```bash
# Test current build state
pnpm clean
pnpm build --filter=@aibos/ui
pnpm build --filter=@aibos/ui-business
pnpm build --filter=apps/web
pnpm build --filter=apps/bff
```

### Phase 2: UI Primitives Cleanup (Week 2)

#### 2.1 Remove Business Logic from UI

```bash
# Identify business components in UI primitives
grep -r "business\|domain\|cfo\|accounting" packages/ui/src/ --include="*.tsx" --include="*.ts"
```

**Actions**:
1. Move business components to `packages/ui-business`
2. Extract pure UI components
3. Update exports

#### 2.2 Ensure Polymorphic Components

```bash
# Check all components use createPolymorphic
grep -r "createPolymorphic" packages/ui/src/ --include="*.tsx"
grep -r "forwardRef" packages/ui/src/ --include="*.tsx"
```

**Actions**:
1. Convert remaining components to polymorphic
2. Add `as` prop support
3. Ensure ref forwarding

#### 2.3 Update Package Dependencies

```json
// packages/ui/package.json
{
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0"
  },
  "devDependencies": {
    "@types/react": "^18.2.0",
    "@types/react-dom": "^18.2.0",
    "typescript": "^5.9.2"
  }
}
```

### Phase 3: UI-Business Restructuring (Week 3)

#### 3.1 Organize by Domain

```bash
# Create domain structure
mkdir -p packages/ui-business/src/{cfo-dashboard,accounting,finance,hr,operations}
```

#### 3.2 Move Business Components

```bash
# Move CFO dashboard components
mv packages/ui/src/components/cfo-dashboard packages/ui-business/src/cfo-dashboard/

# Move accounting components  
mv packages/ui/src/components/accounting packages/ui-business/src/accounting/

# Update imports
find packages/ui-business -name "*.tsx" -exec sed -i 's/@aibos\/ui\/components/@aibos\/ui/g' {} \;
```

#### 3.3 Update Domain Contracts Integration

```tsx
// packages/ui-business/src/cfo-dashboard/index.ts
export { OutstandingCFODashboard } from './outstanding-cfo-dashboard';
export type { OutstandingCFODashboardProps } from './outstanding-cfo-dashboard';

// packages/ui-business/src/accounting/index.ts  
export { ChartOfAccounts } from './chart-of-accounts';
export { JournalEntryForm } from './journal-entry-form';
export { TrialBalance } from './trial-balance';
```

#### 3.4 Update Package Dependencies

```json
// packages/ui-business/package.json
{
  "dependencies": {
    "@aibos/ui": "workspace:*",
    "@aibos/accounting-contracts": "workspace:*",
    "react": "^18.2.0"
  },
  "devDependencies": {
    "@types/react": "^18.2.0",
    "typescript": "^5.9.2"
  }
}
```

### Phase 4: Apps Refactoring (Week 4)

#### 4.1 Update App Imports

```bash
# Update web app imports
find apps/web -name "*.tsx" -exec sed -i 's/@aibos\/ui\/components/@aibos\/ui-business/g' {} \;

# Update BFF imports if any
find apps/bff -name "*.tsx" -exec sed -i 's/@aibos\/ui\/components/@aibos\/ui-business/g' {} \;
```

#### 4.2 Create App-Specific Components

```tsx
// apps/web/src/components/page-layout.tsx
import { OutstandingCFODashboard } from '@aibos/ui-business';

export function CFOPageLayout({ data, onExport }: Props) {
  return (
    <div className="cfo-page-layout">
      <OutstandingCFODashboard 
        data={data}
        onExportBoardPack={onExport}
      />
    </div>
  );
}
```

#### 4.3 Update App Dependencies

```json
// apps/web/package.json
{
  "dependencies": {
    "@aibos/ui-business": "workspace:*",
    "@aibos/accounting-contracts": "workspace:*"
  }
}
```

### Phase 5: Build System Optimization (Week 5)

#### 5.1 Update Build Scripts

```json
// package.json
{
  "scripts": {
    "build:ui": "pnpm build --filter=@aibos/ui",
    "build:ui-business": "pnpm build --filter=@aibos/ui-business", 
    "build:apps": "pnpm build --filter=apps/*",
    "build:all": "pnpm build:ui && pnpm build:ui-business && pnpm build:apps",
    "clean": "pnpm clean --filter=@aibos/ui --filter=@aibos/ui-business --filter=apps/*",
    "typecheck": "pnpm typecheck --filter=@aibos/ui --filter=@aibos/ui-business --filter=apps/*"
  }
}
```

#### 5.2 Add Quality Gates

```bash
# Create quality gate script
cat > scripts/quality-gates.js << 'EOF'
const { execSync } = require('child_process');

function runQualityGates() {
  console.log('🚀 Running Quality Gates...');
  
  try {
    // 1. Type checking
    console.log('📝 Type checking...');
    execSync('pnpm typecheck', { stdio: 'inherit' });
    
    // 2. Linting
    console.log('🔍 Linting...');
    execSync('pnpm lint', { stdio: 'inherit' });
    
    // 3. Build test
    console.log('🔨 Build test...');
    execSync('pnpm build:all', { stdio: 'inherit' });
    
    // 4. Bundle size check
    console.log('📦 Bundle size check...');
    execSync('pnpm size-check', { stdio: 'inherit' });
    
    console.log('✅ All quality gates passed!');
  } catch (error) {
    console.error('❌ Quality gate failed:', error.message);
    process.exit(1);
  }
}

runQualityGates();
EOF
```

#### 5.3 Add Layer Boundary Tests

```tsx
// tests/layer-boundaries.test.ts
import { readFileSync } from 'fs';
import { join } from 'path';

describe('Layer Boundaries', () => {
  it('UI primitives should not import business packages', () => {
    const uiFiles = getAllFiles('packages/ui/src');
    const violations = uiFiles.filter(file => 
      file.includes('@aibos/ui-business') || 
      file.includes('@aibos/accounting-contracts')
    );
    
    expect(violations).toHaveLength(0);
  });
  
  it('Apps should not import UI primitives directly', () => {
    const appFiles = getAllFiles('apps');
    const violations = appFiles.filter(file => 
      file.includes('@aibos/ui/primitives') ||
      file.includes('@aibos/ui/components')
    );
    
    expect(violations).toHaveLength(0);
  });
});
```

### Phase 6: Testing & Validation (Week 6)

#### 6.1 Integration Tests

```tsx
// tests/integration/ui-business.test.tsx
import { render } from '@testing-library/react';
import { OutstandingCFODashboard } from '@aibos/ui-business';

describe('UI-Business Integration', () => {
  it('should render CFO dashboard with UI primitives', () => {
    const mockData = {
      kpis: [],
      companies: [],
      period: { year: 2024, month: 1 }
    };
    
    const { container } = render(
      <OutstandingCFODashboard 
        data={mockData}
        onExportBoardPack={() => {}}
      />
    );
    
    expect(container).toBeInTheDocument();
  });
});
```

#### 6.2 Build Validation

```bash
# Test clean builds
pnpm clean
pnpm build:ui
pnpm build:ui-business  
pnpm build:apps

# Test incremental builds
pnpm build:ui-business  # Should work without rebuilding ui
pnpm build:apps          # Should work without rebuilding ui-business
```

#### 6.3 Performance Testing

```bash
# Bundle size analysis
pnpm build:ui && npx bundle-analyzer packages/ui/dist/index.js
pnpm build:ui-business && npx bundle-analyzer packages/ui-business/dist/index.js
```

## 🚨 Risk Mitigation

### Rollback Plan

1. **Git Branches**: Create feature branches for each phase
2. **Incremental Commits**: Small, testable commits
3. **Build Validation**: Test builds after each change
4. **Documentation**: Document all changes

### Common Issues & Solutions

#### Issue 1: Circular Dependencies

```bash
# Solution: Use dependency injection
# Instead of direct imports, use props/context
```

#### Issue 2: Build Failures

```bash
# Solution: Update build order
pnpm build:ui
pnpm build:ui-business
pnpm build:apps
```

#### Issue 3: Type Errors

```bash
# Solution: Regenerate types
pnpm typecheck
pnpm build:types
```

## 📋 Success Criteria

### Phase Completion Criteria

- [ ] **Phase 1**: All violations identified and documented
- [ ] **Phase 2**: UI primitives contain only pure UI components
- [ ] **Phase 3**: UI-business contains only domain-specific components
- [ ] **Phase 4**: Apps import only from ui-business
- [ ] **Phase 5**: Clean build pipeline established
- [ ] **Phase 6**: All tests passing, performance validated

### Final Success Metrics

- ✅ **Zero circular dependencies**
- ✅ **Clean builds** (< 2 minutes total)
- ✅ **Type safety** (100% TypeScript coverage)
- ✅ **Bundle optimization** (UI: < 50KB, UI-Business: < 100KB)
- ✅ **Test coverage** (> 90%)
- ✅ **Developer experience** (clear separation, easy refactoring)

## 🎯 Timeline

| Week | Phase | Deliverables |
|------|-------|-------------|
| 1 | Audit & Preparation | Dependency audit, component inventory, build test |
| 2 | UI Primitives Cleanup | Pure UI components, polymorphic support |
| 3 | UI-Business Restructuring | Domain organization, business components |
| 4 | Apps Refactoring | Import updates, app-specific components |
| 5 | Build System Optimization | Quality gates, build scripts |
| 6 | Testing & Validation | Integration tests, performance validation |

## 🚀 Getting Started

```bash
# 1. Create feature branch
git checkout -b refactor/ui-ecosystem

# 2. Run initial audit
node scripts/audit-dependencies.js

# 3. Start with Phase 1
pnpm run audit:components
pnpm run test:build

# 4. Follow phase-by-phase plan
```

This refactoring plan ensures a clean, maintainable UI ecosystem that scales with your business needs while maintaining developer productivity and code quality.
